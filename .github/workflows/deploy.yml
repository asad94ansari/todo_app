name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_BACKEND: ${{ github.repository_owner }}/todo-backend
  IMAGE_FRONTEND: ${{ github.repository_owner }}/todo-frontend
  IMAGE_MCP_SERVER: ${{ github.repository_owner }}/todo-mcp-server

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff flake8

    - name: Lint Python code
      run: |
        # Check backend code
        if [ -d "phase-2/backend" ]; then
          echo "Linting backend code..."
          ruff check phase-2/backend/
          flake8 phase-2/backend/ --max-line-length=88
        fi

        # Check MCP server code
        if [ -d "phase-3/mcp-server" ]; then
          echo "Linting MCP server code..."
          ruff check phase-3/mcp-server/
          flake8 phase-3/mcp-server/ --max-line-length=88
        fi

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: phase-2/frontend/package-lock.json

    - name: Install Node.js dependencies
      run: |
        if [ -d "phase-2/frontend" ]; then
          cd phase-2/frontend
          npm ci
        fi

    - name: Lint JavaScript/TypeScript code
      run: |
        if [ -d "phase-2/frontend" ]; then
          cd phase-2/frontend
          npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0
        fi

  build-and-push:
    needs: lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTER }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_BACKEND }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_FRONTEND }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_MCP_SERVER }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{date 'YYYYMMDD'}}-,format=short
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push backend image
      if: hashFiles('phase-2/backend/Dockerfile') != ''
      uses: docker/build-push-action@v5
      with:
        context: phase-2/backend
        file: phase-2/backend/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_BACKEND }}:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push frontend image
      if: hashFiles('phase-2/frontend/Dockerfile') != ''
      uses: docker/build-push-action@v5
      with:
        context: phase-2/frontend
        file: phase-2/frontend/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push MCP server image
      if: hashFiles('phase-3/mcp-server/Dockerfile') != ''
      uses: docker/build-push-action@v5
      with:
        context: phase-3/mcp-server
        file: phase-3/mcp-server/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_MCP_SERVER }}:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  update-manifests:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Install yq
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Update Helm values with new image tags
      run: |
        # Update backend image tag
        if [ -f "phase-4/helm-charts/todo-stack/values.yaml" ]; then
          yq eval ".backend.image.tag = \"${{ github.sha }}\"" -i phase-4/helm-charts/todo-stack/values.yaml
          echo "Updated backend image tag to ${{ github.sha }}"
        fi

        # Update frontend image tag
        if [ -f "phase-4/helm-charts/todo-stack/values.yaml" ]; then
          yq eval ".frontend.image.tag = \"${{ github.sha }}\"" -i phase-4/helm-charts/todo-stack/values.yaml
          echo "Updated frontend image tag to ${{ github.sha }}"
        fi

        # Update MCP server image tag
        if [ -f "phase-4/helm-charts/todo-stack/values.yaml" ]; then
          yq eval ".mcpServer.image.tag = \"${{ github.sha }}\"" -i phase-4/helm-charts/todo-stack/values.yaml
          echo "Updated MCP server image tag to ${{ github.sha }}"
        fi

    - name: Verify Helm chart
      run: |
        if [ -d "phase-4/helm-charts/todo-stack" ]; then
          cd phase-4/helm-charts/todo-stack
          helm lint .

          # Generate manifests to verify they're valid
          helm template test-release . > /tmp/generated-manifests.yaml
          echo "Generated manifests successfully"

          # Validate Kubernetes manifests
          kubectl kustomize --load-restrict=false . || echo "Skipping kubectl validation"
        fi
      env:
        KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}

    - name: Commit updated values.yaml
      run: |
        if [ -f "phase-4/helm-charts/todo-stack/values.yaml" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add phase-4/helm-charts/todo-stack/values.yaml
          git commit -m "Update Helm values with new image tags for ${{ github.sha }}" || echo "No changes to commit"
          git push origin ${{ github.ref }}
        fi

  deploy-simulation:
    needs: update-manifests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Simulate deployment to Kubernetes
      run: |
        if [ -d "phase-4/helm-charts/todo-stack" ]; then
          cd phase-4/helm-charts/todo-stack

          # Run helm template to generate manifests
          echo "Generating Kubernetes manifests..."
          helm template todo-app . --set backend.image.tag="${{ github.sha }}" --set frontend.image.tag="${{ github.sha }}" --set mcpServer.image.tag="${{ github.sha }}" > generated-manifests.yaml

          # Validate generated manifests
          echo "Validating generated manifests..."
          if command -v kubectl &> /dev/null; then
            kubectl apply --dry-run=client -f generated-manifests.yaml
          fi

          echo "Deployment simulation completed successfully"
        else
          echo "Helm chart not found, skipping deployment simulation"
        fi